<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit} ? 'Modifica Password' : 'Nuova Password'">Password Form</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f8f9fa; 
            color: #333;
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            margin-bottom: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .password-form { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 8px; 
            margin-bottom: 30px; 
            border-left: 4px solid #3498db;
        }
        .success-message { 
            background: #d4edda; 
            color: #155724; 
            padding: 12px; 
            border-radius: 5px; 
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
        }
        input, textarea { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            box-sizing: border-box; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 16px;
        }
        input:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        button { 
            background: #3498db; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            cursor: pointer; 
            margin: 5px 5px 5px 0; 
            border-radius: 4px; 
            font-size: 14px;
            transition: background-color 0.2s;
        }
        button:hover {
            background: #2980b9;
        }
        .cancel-btn {
            background: #6c757d;
        }
        .cancel-btn:hover {
            background: #5a6268;
        }
        .password-container { 
            display: flex; 
            align-items: center;
        }
        .password-input { 
            flex: 1; 
        }
        .form-actions {
            display: flex;
            gap: 10px;
        }
		.password-tools {
		    margin: 15px 0;
		    padding: 15px;
		    background: #f8f9fa;
		    border-radius: 5px;
		    border-left: 4px solid #17a2b8;
		}

		.tool-section h4 {
		    margin-top: 0;
		    color: #2c3e50;
		}

		.tool-item {
		    margin: 10px 0;
		}

		.tool-btn {
		    background: #17a2b8;
		    color: white;
		    border: none;
		    padding: 8px 12px;
		    border-radius: 4px;
		    cursor: pointer;
		    margin: 0 5px 5px 0;
		    font-size: 14px;
		}

		.tool-btn:hover {
		    background: #138496;
		}

		.tool-btn.cancel {
		    background: #6c757d;
		}

		.tool-btn.cancel:hover {
		    background: #5a6268;
		}

		.password-options {
		    margin: 10px 0;
		    padding: 10px;
		    background: white;
		    border-radius: 4px;
		    border: 1px solid #ddd;
		}

		.option-group {
		    margin: 8px 0;
		}

		.option-group label {
		    margin-right: 15px;
		    font-size: 14px;
		}

		.analysis-result {
		    margin-top: 10px;
		    padding: 10px;
		    background: white;
		    border-radius: 4px;
		    border: 1px solid #ddd;
		}

		.strength-indicator {
		    font-size: 16px;
		    margin-bottom: 8px;
		}

		.strength-tips {
		    font-size: 14px;
		    color: #6c757d;
		}
    </style>
</head>
<body>
    <div class="container">
        <h1 th:text="${isEdit} ? '‚úèÔ∏è Modifica Password' : '‚ûï Nuova Password'">Form Password</h1>
        
        <!-- Messaggio di successo -->
        <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>
        
        <!-- Messaggio di errore -->
        <div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>
        
        <!-- Form per aggiungere/modificare password -->
        <div class="password-form">
            <form th:action="@{/save}" method="post" th:object="${passwordEntryForm}">
                <input type="hidden" th:field="*{id}" />
                
                <input type="text" th:field="*{title}" 
                       placeholder="Titolo (es. Google, Facebook)" required>
                
                <input type="text" th:field="*{username}" 
                       placeholder="Username/Email" required>
                
				<!-- Campo password con toggle -->
				<div class="password-container">
				    <input type="password" 
				           name="plainPassword" 
				           id="passwordField" 
				           th:value="${passwordEntryForm.plainPassword}"
				           placeholder="Password" 
				           class="password-input" 
				           required>
				    <button type="button" class="show-password-btn" onclick="togglePasswordVisibility()">
				        üëÅÔ∏è Mostra
				    </button>
				</div>
				
				<div class="password-tools">
				    <div class="tool-section">
				        <h4>üõ†Ô∏è Strumenti Password</h4>
				        
				        <!-- Generatore Password -->
				        <div class="tool-item">
				            <button type="button" onclick="generatePassword()" class="tool-btn">
				                üé≤ Genera Password Forte
				            </button>
				            <button type="button" onclick="showPasswordOptions()" class="tool-btn">
				                ‚öôÔ∏è Personalizza
				            </button>
				        </div>
				        
				        <!-- Opzioni Generatore (nascosto inizialmente) -->
				        <div id="passwordOptions" class="password-options" style="display: none;">
				            <div class="option-group">
				                <label>Lunghezza: 
				                    <input type="number" id="pwdLength" value="16" min="8" max="50">
				                </label>
				            </div>
				            <div class="option-group">
				                <label><input type="checkbox" id="useUppercase" checked> Lettere Maiuscole</label>
				                <label><input type="checkbox" id="useLowercase" checked> Lettere Minuscole</label>
				                <label><input type="checkbox" id="useNumbers" checked> Numeri</label>
				                <label><input type="checkbox" id="useSymbols" checked> Simboli</label>
				            </div>
				            <div class="option-group">
				                <button type="button" onclick="generateCustomPassword()" class="tool-btn">
				                    Genera
				                </button>
				                <button type="button" onclick="hidePasswordOptions()" class="tool-btn cancel">
				                    Annulla
				                </button>
				            </div>
				        </div>
				        
				        <!-- Analizzatore Password -->
				        <div class="tool-item">
				            <div id="passwordAnalysis" class="analysis-result"></div>
				        </div>
				    </div>
				</div>
                
                <input type="url" th:field="*{url}" 
                       placeholder="URL (opzionale)">
					   
					   <div class="form-group">
					       <label for="category">Categoria:</label>
					       <select th:field="*{category}" id="category" class="form-select">
					           <option value="Generale">Generale</option>
					           <option value="Email">Email</option>
					           <option value="Social Media">Social Media</option>
					           <option value="Lavoro">Lavoro</option>
					           <option value="Banca/Finanza">Banca/Finanza</option>
					           <option value="Shopping">Shopping</option>
					           <option value="Intrattenimento">Intrattenimento</option>
					           <option value="Istruzione">Istruzione</option>
					           <option value="Viaggi">Viaggi</option>
					           <option value="Salute">Salute</option>
					           <option value="Altro">Altro</option>
					       </select>
					       <small class="form-text text-muted">
					           Oppure <a href="javascript:void(0)" onclick="showCustomCategory()">inserisci una nuova categoria</a>
					       </small>
					       
					       <!-- Campo per categoria personalizzata (nascosto) -->
					       <div id="customCategoryGroup" style="display: none; margin-top: 10px;">
					           <input type="text" id="customCategory" placeholder="Nome nuova categoria" 
					                  class="form-control" style="max-width: 300px;">
					           <button type="button" onclick="addCustomCategory()" class="tool-btn" style="margin-top: 5px;">
					               ‚ûï Aggiungi Categoria
					           </button>
					       </div>
					   </div>
                
                <textarea th:field="*{notes}" placeholder="Note (opzionale)" rows="3"></textarea>
                
				<div class="form-actions">
				        <button type="submit" th:text="${passwordEntryForm.id == null} ? 'Salva Password' : 'Aggiorna Password'">
				            Salva
				        </button>
				        <a th:href="@{/}" class="cancel-btn" style="text-decoration: none; color: white; display: inline-block; padding: 12px 20px;">
				            Annulla
				        </a>
				</div>
            </form>
        </div>
    </div>

    <script>
        // Funzione per mostrare/nascondere la password nel form
        function togglePasswordVisibility() {
            const passwordField = document.getElementById('passwordField');
            const button = event.target;
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                button.textContent = 'üôà Nascondi';
            } else {
                passwordField.type = 'password';
                button.textContent = 'üëÅÔ∏è Mostra';
            }
        }
		
		// Genera una password forte
		function generatePassword() {
		    fetch('/api/password-tools/generate')
		        .then(response => response.text())
		        .then(password => {
		            document.getElementById('passwordField').value = password;
		            document.getElementById('passwordField').type = 'text';
		            analyzePassword(); // Analizza automaticamente la password generata
		        })
		        .catch(error => {
		            console.error('Errore nella generazione password:', error);
		            alert('Errore nella generazione della password');
		        });
		}

		// Mostra/nascondi opzioni personalizzate
		function showPasswordOptions() {
		    document.getElementById('passwordOptions').style.display = 'block';
		}

		function hidePasswordOptions() {
		    document.getElementById('passwordOptions').style.display = 'none';
		}

		// Genera password personalizzata
		function generateCustomPassword() {
		    const options = {
		        length: parseInt(document.getElementById('pwdLength').value),
		        uppercase: document.getElementById('useUppercase').checked,
		        lowercase: document.getElementById('useLowercase').checked,
		        numbers: document.getElementById('useNumbers').checked,
		        symbols: document.getElementById('useSymbols').checked
		    };
		    
		    fetch('/api/password-tools/generate-custom', {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json',
		        },
		        body: JSON.stringify(options)
		    })
		    .then(response => response.text())
		    .then(password => {
		        document.getElementById('passwordField').value = password;
		        document.getElementById('passwordField').type = 'text';
		        hidePasswordOptions();
		        analyzePassword();
		    })
		    .catch(error => {
		        console.error('Errore nella generazione password personalizzata:', error);
		        alert('Errore nella generazione della password');
		    });
		}

		// Analizza la sicurezza della password
		function analyzePassword() {
		    const password = document.getElementById('passwordField').value;
		    const analysisDiv = document.getElementById('passwordAnalysis');
		    
		    console.log('Analizzando password:', password);
		    
		    if (!password) {
		        analysisDiv.innerHTML = '<div style="color: #6c757d; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">Inserisci una password per analizzarla</div>';
		        return;
		    }
		    
		    analysisDiv.innerHTML = '<div style="color: #6c757d; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">Analisi in corso...</div>';
		    
		    fetch(`/api/password-tools/analyze?password=${encodeURIComponent(password)}`)
		        .then(response => {
		            console.log('Response status:', response.status);
		            if (!response.ok) {
		                throw new Error('Errore HTTP: ' + response.status);
		            }
		            return response.json();
		        })
		        .then(analysis => {
		            console.log('Analisi ricevuta:', analysis);
		            
		            // Usa i campi direttamente dalla mappa
		            analysisDiv.innerHTML = `
		                <div class="strength-indicator" style="color: ${analysis.color}; padding: 10px; border-left: 4px solid ${analysis.color}; background: #f8f9fa; border-radius: 4px;">
		                    <strong style="font-size: 16px;">${analysis.description}</strong>
		                    ${analysis.tips ? `<div style="margin-top: 8px; font-size: 14px; color: #495057;">${analysis.tips.replace(/\n/g, '<br>')}</div>` : ''}
		                </div>
		            `;
		        })
		        .catch(error => {
		            console.error('Errore nell\'analisi password:', error);
		            analysisDiv.innerHTML = `
		                <div style="color: #dc3545; padding: 10px; border: 1px solid #dc3545; border-radius: 4px;">
		                    Errore nell'analisi: ${error.message}
		                </div>
		            `;
		        });
		}

		// Analizza la password in tempo reale
		document.getElementById('passwordField').addEventListener('input', function() {
		    clearTimeout(this.analysisTimeout);
		    this.analysisTimeout = setTimeout(analyzePassword, 500);
		});
		
		// Mostra/nascondi campo categoria personalizzata
		function showCustomCategory() {
		    document.getElementById('customCategoryGroup').style.display = 'block';
		    document.getElementById('category').style.display = 'none';
		    document.querySelector('small a').style.display = 'none';
		}

		// Aggiungi categoria personalizzata
		function addCustomCategory() {
		    const customCategory = document.getElementById('customCategory').value.trim();
		    
		    if (!customCategory) {
		        alert('Inserisci un nome per la categoria');
		        return;
		    }
		    
		    // Aggiungi al dropdown
		    const select = document.getElementById('category');
		    const option = document.createElement('option');
		    option.value = customCategory;
		    option.textContent = customCategory;
		    select.appendChild(option);
		    
		    // Seleziona la nuova categoria
		    select.value = customCategory;
		    
		    // Ripristina vista normale
		    document.getElementById('customCategoryGroup').style.display = 'none';
		    document.getElementById('category').style.display = 'block';
		    document.querySelector('small a').style.display = 'inline';
		    document.getElementById('customCategory').value = '';
		}
    </script>
</body>
</html>