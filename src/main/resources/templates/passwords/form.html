<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit} ? 'Modifica Password' : 'Nuova Password'">Password Form</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f8f9fa; 
            color: #333;
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            margin-bottom: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .password-form { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 8px; 
            margin-bottom: 30px; 
            border-left: 4px solid #3498db;
        }
        .success-message { 
            background: #d4edda; 
            color: #155724; 
            padding: 12px; 
            border-radius: 5px; 
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
        }
        input, textarea { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            box-sizing: border-box; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 16px;
        }
        input:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        button { 
            background: #3498db; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            cursor: pointer; 
            margin: 5px 5px 5px 0; 
            border-radius: 4px; 
            font-size: 14px;
            transition: background-color 0.2s;
        }
        button:hover {
            background: #2980b9;
        }
        .cancel-btn {
            background: #6c757d;
        }
        .cancel-btn:hover {
            background: #5a6268;
        }
        .password-container { 
            display: flex; 
            align-items: center;
        }
        .password-input { 
            flex: 1; 
        }
        .form-actions {
            display: flex;
            gap: 10px;
        }
		.password-tools {
		    margin: 15px 0;
		    padding: 15px;
		    background: #f8f9fa;
		    border-radius: 5px;
		    border-left: 4px solid #17a2b8;
		}

		.tool-section h4 {
		    margin-top: 0;
		    color: #2c3e50;
		}

		.tool-item {
		    margin: 10px 0;
		}

		.tool-btn {
		    background: #17a2b8;
		    color: white;
		    border: none;
		    padding: 8px 12px;
		    border-radius: 4px;
		    cursor: pointer;
		    margin: 0 5px 5px 0;
		    font-size: 14px;
		}

		.tool-btn:hover {
		    background: #138496;
		}

		.tool-btn.cancel {
		    background: #6c757d;
		}

		.tool-btn.cancel:hover {
		    background: #5a6268;
		}

		.password-options {
		    margin: 10px 0;
		    padding: 10px;
		    background: white;
		    border-radius: 4px;
		    border: 1px solid #ddd;
		}

		.option-group {
		    margin: 8px 0;
		}

		.option-group label {
		    margin-right: 15px;
		    font-size: 14px;
		}

		.analysis-result {
		    margin-top: 10px;
		    padding: 10px;
		    background: white;
		    border-radius: 4px;
		    border: 1px solid #ddd;
		}

		.strength-indicator {
		    font-size: 16px;
		    margin-bottom: 8px;
		}

		.strength-tips {
		    font-size: 14px;
		    color: #6c757d;
		}
		.hibp-alert {
		    margin: 15px 0;
		    padding: 15px;
		    border-radius: 5px;
		    border-left: 4px solid;
		}

		.hibp-safe {
		    border-left-color: #28a745;
		    background: #d4edda;
		    color: #155724;
		}

		.hibp-warning {
		    border-left-color: #ffc107;
		    background: #fff3cd;
		    color: #856404;
		}

		.hibp-danger {
		    border-left-color: #dc3545;
		    background: #f8d7da;
		    color: #721c24;
		}

		.hibp-loading {
		    border-left-color: #17a2b8;
		    background: #d1ecf1;
		    color: #0c5460;
		}
    </style>
</head>
<body>
    <div class="container">
        <h1 th:text="${isEdit} ? '‚úèÔ∏è Modifica Password' : '‚ûï Nuova Password'">Form Password</h1>
        
        <!-- Messaggio di successo -->
        <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>
        
        <!-- Messaggio di errore -->
        <div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>
        
        <!-- Form per aggiungere/modificare password -->
        <div class="password-form">
            <form th:action="@{/save}" method="post" th:object="${passwordEntryForm}">
                <input type="hidden" th:field="*{id}" />
                
                <input type="text" th:field="*{title}" 
                       placeholder="Titolo (es. Google, Facebook)" required>
                
                <input type="text" th:field="*{username}" 
                       placeholder="Username/Email" required>
                
				<!-- Campo password con toggle -->
				<div class="password-container">
				    <input type="password" 
				           name="plainPassword" 
				           id="passwordField" 
				           th:value="${passwordEntryForm.plainPassword}"
				           placeholder="Password" 
				           class="password-input" 
				           required>
				    <button type="button" class="show-password-btn" onclick="togglePasswordVisibility()">
				        üëÅÔ∏è Mostra
				    </button>
				</div>
				
				<div id="hibpResult" class="analysis-result" style="margin-top: 10px; display: none;">
				    <div class="breach-alert" style="padding: 10px; border-radius: 5px; margin: 5px 0;">
				        <div style="display: flex; align-items: center; gap: 10px;">
				            <span id="hibpIcon" style="font-size: 20px;">üîç</span>
				            <div>
				                <strong id="hibpMessage">Verificando sicurezza...</strong>
				                <div id="hibpSuggestions" style="font-size: 14px; margin-top: 5px;"></div>
				            </div>
				        </div>
				    </div>
				</div>
				
				<div class="password-tools">
					<div class="tool-section">
					    <h4>üõ†Ô∏è Strumenti Password</h4>
						<div class="tool-item">
							<button type="button" onclick="generatePassword()" class="tool-btn">
								üé≤ Genera Password Sicura
							</button>
							<small style="display: block; margin-top: 5px; color: #6c757d;">
								La password generata verr√† automaticamente verificata contro HIBP
							</small>
						</div>
					</div>
				</div>
                
                <input type="url" th:field="*{url}" 
                       placeholder="URL (opzionale)">
					   
					   <div class="form-group">
					       <label for="category">Categoria:</label>
					       <select th:field="*{category}" id="category" class="form-select">
					           <option value="Generale">Generale</option>
					           <option value="Email">Email</option>
					           <option value="Social Media">Social Media</option>
					           <option value="Lavoro">Lavoro</option>
					           <option value="Banca/Finanza">Banca/Finanza</option>
					           <option value="Shopping">Shopping</option>
					           <option value="Intrattenimento">Intrattenimento</option>
					           <option value="Istruzione">Istruzione</option>
					           <option value="Viaggi">Viaggi</option>
					           <option value="Salute">Salute</option>
					           <option value="Altro">Altro</option>
					       </select>
					       <small class="form-text text-muted">
					           Oppure <a href="javascript:void(0)" onclick="showCustomCategory()">inserisci una nuova categoria</a>
					       </small>
					       
					       <!-- Campo per categoria personalizzata (nascosto) -->
					       <div id="customCategoryGroup" style="display: none; margin-top: 10px;">
					           <input type="text" id="customCategory" placeholder="Nome nuova categoria" 
					                  class="form-control" style="max-width: 300px;">
					           <button type="button" onclick="addCustomCategory()" class="tool-btn" style="margin-top: 5px;">
					               ‚ûï Aggiungi Categoria
					           </button>
					       </div>
					   </div>
                
                <textarea th:field="*{notes}" placeholder="Note (opzionale)" rows="3"></textarea>
                
				<div class="form-actions">
				        <button type="submit" th:text="${passwordEntryForm.id == null} ? 'Salva Password' : 'Aggiorna Password'">
				            Salva
				        </button>
						<button type="button" class="cancel-btn" onclick="window.location.href='/'">
						    Annulla
						</button>
				</div>
            </form>
        </div>
    </div>

	<script>
	    // Funzione per mostrare/nascondere la password
	    function togglePasswordVisibility() {
	        const passwordField = document.getElementById('passwordField');
	        const button = event.target;
	        
	        if (passwordField.type === 'password') {
	            passwordField.type = 'text';
	            button.textContent = 'üôà Nascondi';
	        } else {
	            passwordField.type = 'password';
	            button.textContent = 'üëÅÔ∏è Mostra';
	        }
	    }
	    
	    // Genera password sicura
	    function generatePassword() {
	        fetch('/api/password-tools/generate')
	            .then(response => response.text())
	            .then(password => {
	                const passwordField = document.getElementById('passwordField');
	                passwordField.value = password;
	                passwordField.type = 'text';
	                checkHibp(password); // Verifica immediatamente
	            })
	            .catch(error => {
	                console.error('Errore generazione password:', error);
	                alert('Errore nella generazione della password');
	            });
	    }
	    
	    // Verifica HIBP
	    function checkHibp(password) {
	        if (!password || password.length < 4) {
	            hideHibpResult();
	            return;
	        }
	        
	        showHibpResult('loading', 'Verificando nei database di leak...', []);
	        
	        fetch('/api/security/check-password', {
	            method: 'POST',
	            headers: { 'Content-Type': 'application/json' },
	            body: JSON.stringify({ password: password })
	        })
	        .then(response => {
	            if (!response.ok) throw new Error('Errore HTTP: ' + response.status);
	            return response.json();
	        })
	        .then(data => {
	            const riskLevel = data.riskLevel || 'UNKNOWN';
	            const message = data.message || 'Verifica completata';
	            const suggestions = data.suggestions || [];
	            
	            showHibpResult(riskLevel.toLowerCase(), message, suggestions);
	        })
	        .catch(error => {
	            console.error('Errore HIBP:', error);
	            showHibpResult('error', 'Impossibile verificare la password (errore di connessione)', [
	                'Controlla la tua connessione internet',
	                'Riprova pi√π tardi'
	            ]);
	        });
	    }
	    
	    // Mostra risultato HIBP
	    function showHibpResult(type, message, suggestions) {
	        const resultDiv = document.getElementById('hibpResult');
	        const iconSpan = document.getElementById('hibpIcon');
	        const messageSpan = document.getElementById('hibpMessage');
	        const suggestionsDiv = document.getElementById('hibpSuggestions');
	        
	        // Rimuovi tutte le classi precedenti
	        resultDiv.className = 'hibp-alert';
	        
	        // Imposta stile in base al tipo
	        const config = {
	            'low': { icon: '‚úÖ', className: 'hibp-safe' },
	            'medium': { icon: '‚ö†Ô∏è', className: 'hibp-warning' },
	            'high': { icon: 'üö®', className: 'hibp-danger' },
	            'critical': { icon: 'üî¥', className: 'hibp-danger' },
	            'loading': { icon: 'üîç', className: 'hibp-loading' },
	            'error': { icon: '‚ö†Ô∏è', className: 'hibp-danger' },
	            'unknown': { icon: '‚ùì', className: 'hibp-loading' }
	        };
	        
	        const cfg = config[type] || config.unknown;
	        
	        resultDiv.classList.add(cfg.className.replace('hibp-', ''));
	        iconSpan.textContent = cfg.icon;
	        messageSpan.textContent = message;
	        
	        if (suggestions.length > 0) {
	            suggestionsDiv.innerHTML = suggestions.map(s => 
	                `<div style="margin: 3px 0;">‚Ä¢ ${s}</div>`
	            ).join('');
	        } else {
	            suggestionsDiv.innerHTML = '';
	        }
	        
	        resultDiv.style.display = 'block';
	    }
	    
	    function hideHibpResult() {
	        document.getElementById('hibpResult').style.display = 'none';
	    }
	    
	    // Verifica in tempo reale
	    document.getElementById('passwordField').addEventListener('input', function() {
	        const password = this.value;
	        clearTimeout(this.hibpTimeout);
	        this.hibpTimeout = setTimeout(() => checkHibp(password), 800);
	    });
	    
	    // Verifica all'avvio se c'√® gi√† una password (modalit√† modifica)
	    document.addEventListener('DOMContentLoaded', function() {
	        const passwordField = document.getElementById('passwordField');
	        if (passwordField.value) {
	            setTimeout(() => checkHibp(passwordField.value), 500);
	        }
	    });
	    
	    // Funzioni categoria (mantieni)
	    function showCustomCategory() {
	        document.getElementById('customCategoryGroup').style.display = 'block';
	        document.getElementById('category').style.display = 'none';
	        document.querySelector('small a').style.display = 'none';
	    }
	    
	    function addCustomCategory() {
	        const customCategory = document.getElementById('customCategory').value.trim();
	        
	        if (!customCategory) {
	            alert('Inserisci un nome per la categoria');
	            return;
	        }
	        
	        const select = document.getElementById('category');
	        const option = document.createElement('option');
	        option.value = customCategory;
	        option.textContent = customCategory;
	        select.appendChild(option);
	        select.value = customCategory;
	        
	        document.getElementById('customCategoryGroup').style.display = 'none';
	        document.getElementById('category').style.display = 'block';
	        document.querySelector('small a').style.display = 'inline';
	        document.getElementById('customCategory').value = '';
	    }
	</script>
</body>
</html>